#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DO NOT MODIFY BELOW
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo ""
echo " üöÄ  CP4WAIOPS Train Events for $APP_NAME"
echo ""
echo "***************************************************************************************************************************************"


#--------------------------------------------------------------------------------------------------------------------------------------------
#  Check Defaults
#--------------------------------------------------------------------------------------------------------------------------------------------

if [ -x "$(command -v kafkacat)" ]; then
      export KAFKACAT_EXE=kafkacat
      echo "  ‚úÖ  OK - kafkacat installed"
else
      if [ -x "$(command -v kcat)" ]; then
      export KAFKACAT_EXE=kcat
            echo "  ‚úÖ  OK - kcat installed"
      else
            echo "  ‚ùó ERROR: kafkacat is not installed."
            echo "  ‚ùå Aborting..."
            exit 1
      fi
fi

if [[ $APP_NAME == "" ]] ;
then
      echo "‚ö†Ô∏è AppName not defined. Launching this script directly?"
      echo "‚ùå Aborting..."
      exit 1
fi



#--------------------------------------------------------------------------------------------------------------------------------------------
#  Get Credentials
#--------------------------------------------------------------------------------------------------------------------------------------------

echo "***************************************************************************************************************************************"
echo "  üîê  Getting credentials"
echo "***************************************************************************************************************************************"
oc project $WAIOPS_NAMESPACE 

if [[ $EVENTS_TOPIC == "" ]] ;
then
      echo "      üîé Getting Kafka Log Integration"
      export EVENTS_TOPIC=$(oc get kafkatopics -n $WAIOPS_NAMESPACE | grep alerts-$EVENTS_TYPE| awk '{print $1;}')
      export EVENTS_TOPIC_COUNT=$(echo $EVENTS_TOPIC | wc -w)

      if [[ $EVENTS_TOPIC_COUNT -gt 1 ]] ;
      then
            echo "‚ö†Ô∏è  There are several integrations for log type $EVENTS_TYPE:"
            echo "$EVENTS_TOPIC"
            echo "‚ö†Ô∏è  Please get the topic name from AI Hub and override EVENTS_TOPIC in the calling script."
            echo "‚ùå Aborting..."
            exit 1
      else 
       echo "      ‚úÖ OK - Events Topic is: $EVENTS_TOPIC"           
      fi

else
      echo "      ‚úÖ OK - Events Topic defined in calling script: $EVENTS_TOPIC"
fi


export SASL_USER=$(oc get secret ibm-aiops-kafka-secret -n $WAIOPS_NAMESPACE --template={{.data.username}} | base64 --decode)
export SASL_PASSWORD=$(oc get secret ibm-aiops-kafka-secret -n $WAIOPS_NAMESPACE --template={{.data.password}} | base64 --decode)
export KAFKA_BROKER=$(oc get routes iaf-system-kafka-0 -n $WAIOPS_NAMESPACE -o=jsonpath='{.status.ingress[0].host}{"\n"}'):443

export DATE_FORMAT="+%Y-%m-%dT%H:%M:%S"

export WORKING_DIR_EVENTS="./tools/02_training/TRAINING_FILES/KAFKA/$APP_NAME/events"

echo ""
echo ""


#--------------------------------------------------------------------------------------------------------------------------------------------
#  Get the cert for kafkacat
#--------------------------------------------------------------------------------------------------------------------------------------------
echo "***************************************************************************************************************************************"
echo "ü•á Getting Certs"
echo "***************************************************************************************************************************************"
mv ca.crt ca.crt.old
oc extract secret/kafka-secrets -n $WAIOPS_NAMESPACE --keys=ca.crt
echo "      ‚úÖ OK"





#--------------------------------------------------------------------------------------------------------------------------------------------
#  Check Credentials
#--------------------------------------------------------------------------------------------------------------------------------------------

echo "***************************************************************************************************************************************"
echo "  üîó  Checking credentials"
echo "***************************************************************************************************************************************"



if [[ ! $KAFKA_BROKER =~ "iaf-system-kafka-0-$WAIOPS_NAMESPACE" ]] ;
then
      echo "      ‚ùó Kafka Broker not found..."
      echo "      ‚ùå Aborting..."
      exit 1
else
      echo "      ‚úÖ OK - Kafka Broker"
fi

export EVENT_FILES=$(ls -1 $WORKING_DIR_EVENTS | grep "json")
if [[ $EVENT_FILES == "" ]] ;
then
      echo "      ‚ùó No found"
      echo "      ‚ùó    No found to ingest in path $WORKING_DIR_EVENTS"
      echo "      ‚ùó    Please unzip the demo events as described in the documentation of place your own in the directory."
      echo "      ‚ùå Aborting..."
      exit 1
else
      echo "      ‚úÖ OK - Log Files"
fi



echo ""
echo ""
echo ""
echo ""


echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo "  "
echo "  üîé  Parameter for Training"
echo "  "
echo "           üåè Kafka Broker URL            : $KAFKA_BROKER"
echo "           üîê Kafka Password              : $KAFKA_PASSWORD"
echo "  "
echo "           üìÖ Date Format                 : $(date $DATE_FORMAT) ($DATE_FORMAT)"
echo "  "
echo "  "
echo "           üìÇ Directory for Events        : $WORKING_DIR_EVENTS"
echo "  "
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo ""
echo ""
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo "  üóÑÔ∏è  Files to be loaded for Log Anomalies"
echo "***************************************************************************************************************************************"
ls -1 $WORKING_DIR_EVENTS | grep "json"
echo "  "
echo "  "
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"

echo ""
echo ""



echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
  read -p " ‚ùó‚ùì Start Training? [y,N] " DO_COMM
  if [[ $DO_COMM == "y" ||  $DO_COMM == "Y" ]]; then
      echo "   ‚úÖ Ok, continuing..."
      echo ""
      echo ""
      echo ""
      echo ""

  else
    echo "‚ùå Aborted"
    exit 1
  fi
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo ""
echo ""
echo ""
echo ""

#--------------------------------------------------------------------------------------------------------------------------------------------
#  Launch Log Injection as a parallel thread
#--------------------------------------------------------------------------------------------------------------------------------------------
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo " üöÄ  Launching Log Anomaly Training" 
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo ""
echo ""
echo ""
echo ""

for actFile in $(ls -1 $WORKING_DIR_EVENTS | grep "json"); 
do 

#--------------------------------------------------------------------------------------------------------------------------------------------
#  Prepare the Log Data
#--------------------------------------------------------------------------------------------------------------------------------------------

      echo "***************************************************************************************************************************************"
      echo "  üõ†Ô∏è  Preparing Data for file $actFile"
      echo "***************************************************************************************************************************************"


      #--------------------------------------------------------------------------------------------------------------------------------------------
      #  Create file and structure in /tmp
      #--------------------------------------------------------------------------------------------------------------------------------------------
      mkdir /tmp/training-events/  
      rm /tmp/training-events/x* 
      cp $WORKING_DIR_EVENTS/$actFile /tmp/training-events/
      cd /tmp/training-events/

  
      #--------------------------------------------------------------------------------------------------------------------------------------------
      #  Split the files in 1500 line chunks for kafkacat
      #--------------------------------------------------------------------------------------------------------------------------------------------
      echo "    üî® Splitting"
      split -l 1500 $actFile
      export NUM_FILES=$(ls | wc -l)
      rm $actFile
      cd -  
      echo "      ‚úÖ OK"



      #--------------------------------------------------------------------------------------------------------------------------------------------
      #  Inject the Events
      #--------------------------------------------------------------------------------------------------------------------------------------------
      echo "***************************************************************************************************************************************"
      echo "üåè  Injecting Events from File: ${actFile}" 
      echo "     Quit with Ctrl-Z"
      echo "***************************************************************************************************************************************"
      ACT_COUNT=0
      for FILE in /tmp/training-events/*; do 
          if [[ $FILE =~ "x"  ]]; then
              ACT_COUNT=`expr $ACT_COUNT + 1`
              echo "Injecting file ($ACT_COUNT/$(($NUM_FILES-1))) - $FILE"
              ${KAFKACAT_EXE} -v -X security.protocol=SASL_SSL -X ssl.ca.location=./ca.crt -X sasl.mechanisms=SCRAM-SHA-512  -X sasl.username=$SASL_USER -X sasl.password=$SASL_PASSWORD -b $KAFKA_BROKER -P -t $EVENTS_TOPIC -l $FILE   
              echo "      ‚úÖ OK"
          fi
      done
      rm /tmp/training-events/x*
done

#--------------------------------------------------------------------------------------------------------------------------------------------
#  Clean up
#--------------------------------------------------------------------------------------------------------------------------------------------

rm ./ca.crt

echo "***************************************************************************************************************************************"
echo ""
echo " ‚úÖ  Event Injection Done..... "
echo "     Hit ENTER if the command prompt does not appear"
echo ""
echo "***************************************************************************************************************************************"

echo ""
echo ""
echo ""
echo ""
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo ""
echo " üöÄ  CP4WAIOPS Training"
echo " ‚úÖ  Done..... "
echo ""
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"







echo ""
echo ""
echo ""
echo ""
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"
echo ""
echo " üöÄ  CP4WAIOPS Train Events for $APP_NAME"
echo " ‚úÖ  Done..... "
echo ""
echo "***************************************************************************************************************************************"
echo "***************************************************************************************************************************************"


