#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#       __________  __ ___       _____    ________            
#      / ____/ __ \/ // / |     / /   |  /  _/ __ \____  _____
#     / /   / /_/ / // /| | /| / / /| |  / // / / / __ \/ ___/
#    / /___/ ____/__  __/ |/ |/ / ___ |_/ // /_/ / /_/ (__  ) 
#    \____/_/      /_/  |__/|__/_/  |_/___/\____/ .___/____/  
#                                              /_/            
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------"
#  CP4WAIOPS v3.3 - CP4WAIOPS Installation
#
#
#  ¬©2022 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------"
clear

echo "*****************************************************************************************************************************"
echo "*****************************************************************************************************************************"
echo "*****************************************************************************************************************************"
echo "*****************************************************************************************************************************"
echo "  "
echo "  üê• CloudPak for Watson AIOps v3.3 - Easy Install"
echo "  "
echo "*****************************************************************************************************************************"
echo "*****************************************************************************************************************************"
echo "*****************************************************************************************************************************"
echo "  "
echo "  "

export WAIOPS_NAMESPACE=$(oc get po -A|grep aiops-orchestrator-controller |awk '{print$1}')

while :
do
      clear
      echo "*****************************************************************************************************************************"
      echo "  "
      echo "  üê• CloudPak for Watson AIOps v3.3 - Follow Install"
      echo "  "
      echo "*****************************************************************************************************************************"

      echo "  "
      echo "*****************************************************************************************************************************"
      echo "*****************************************************************************************************************************"
      echo "Install Log"
      echo "*****************************************************************************************************************************"

      #tail installAIManager.log
      cat installAIManager.log
      echo "  "
      echo "  "
      echo "  "
      echo "  "
      echo "*****************************************************************************************************************************"
      echo "*****************************************************************************************************************************"

      
      NUM_PODS_MP=$(oc get pods -n openshift-marketplace --no-headers|grep -v Completed| wc -l)
      NUM_PODS_COM=$(oc get pods -n ibm-common-services --no-headers|grep -v Completed| wc -l)
      NUM_PODS_WAI=$(oc get pods -n $WAIOPS_NAMESPACE --no-headers|grep -v Completed| wc -l)
      ERROR_AKORA=$(oc get pods -n $WAIOPS_NAMESPACE --no-headers|grep -v Completed|grep aiops-akora|grep CreateContainerConfigError| wc -l|tr -d ' ')


      echo "  "
      echo "*****************************************************************************************************************************"
      echo "  üê• Namespace: openshift-marketplace"
      echo "    üì• Number of Pods:     $NUM_PODS_MP                                     "
      echo "    ‚ùó Pods Not Ready:                                     "
      oc get pods -n openshift-marketplace --no-headers|grep "0/1"|grep -v Completed| sed 's/^/       /'


      echo "  "
      echo "*****************************************************************************************************************************"
      echo "  üê• Namespace: ibm-common-services"
      echo "    üì• Number of Pods:     $NUM_PODS_COM      (should be around 35 when done)                               "
      echo "    ‚ùó Pods Not Ready:                                     "
      oc get pods -n ibm-common-services --no-headers|grep "0/1"|grep -v Completed| sed 's/^/       /'


      echo "  "
      echo "*****************************************************************************************************************************"
      echo "  üê• Namespace: $WAIOPS_NAMESPACE"
      echo "    üì• Number of Pods:     $NUM_PODS_WAI      (should be around 125 when done)                                       "
      echo "    ‚ùó Pods Not Ready:                                     "
      oc get pods -n $WAIOPS_NAMESPACE --no-headers|grep "0/1"|grep -v Completed| sed 's/^/       /'

      echo "  "
      echo "*****************************************************************************************************************************"
      echo "  üê• CSVs that are not ready"
      oc get csv -A | grep -v 'Succeeded'| sed 's/^/       /'


      if [[ ! $ERROR_AKORA == "0" ]]; then
            echo "  "
            echo "  "
                  echo "  "
            echo "*****************************************************************************************************************************"
            echo "  üê• Easy Install Debug"
            echo "*****************************************************************************************************************************"
            echo "  "
            echo "  ‚ùó Your install seems to be hitting a known problem: https://ibm-cloud.slack.com/archives/C019D1Z89R6/p1645631170165839?thread_ts=1645631030.273159&cid=C019D1Z89R6"
            echo "   Please execute the following command:"
            echo "   oc delete pod $(oc get po -n $WAIOPS_NAMESPACE|grep ibm-common-service-operator|awk '{print$1}') -n $WAIOPS_NAMESPACE"
      fi


      sleep 15
done



